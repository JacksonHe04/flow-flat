# èŠ‚ç‚¹ç»„ä»¶é‡æ„ä¸ç¼–è¾‘åŠŸèƒ½ä¿®å¤

## ğŸ¯ å¼€å‘ç›®æ ‡

é‡æ„ Flow-Flat é¡¹ç›®ä¸­çš„èŠ‚ç‚¹ç»„ä»¶ç³»ç»Ÿï¼Œå®ç°ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
- å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ç¼–å†™æ¯ä¸ªèŠ‚ç‚¹çš„æ ‡é¢˜
- åœ¨èŠ‚ç‚¹å†…é¡¶éƒ¨å±…ä¸­æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹
- å›¾ç‰‡èŠ‚ç‚¹æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- ä¿®å¤å›¾ç‰‡æè¿°æœªæ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹æ–¹çš„é—®é¢˜
- æé«˜ä»£ç å¤ç”¨æ€§ï¼Œåˆ›å»ºé€šç”¨èŠ‚ç‚¹ç»„ä»¶
- ä¿®å¤èŠ‚ç‚¹ç¼–è¾‘åŠŸèƒ½å¤±æ•ˆé—®é¢˜

## ğŸ“ å¼€å‘è¿‡ç¨‹æ‘˜è¦

1. **åˆå§‹é—®é¢˜è¯Šæ–­**ï¼šå‘ç° `Toolbar.tsx` æ–‡ä»¶ä¸­å­˜åœ¨ `NodeTypeConfig` ç±»å‹é”™è¯¯ï¼Œ`title` å±æ€§ä¸å­˜åœ¨ã€‚
2. **ç±»å‹ä¿®å¤**ï¼šå°† `NodeTypeConfig` æ¥å£ä¸­çš„ `title` å±æ€§å¼•ç”¨æ›¿æ¢ä¸º `name` å±æ€§ã€‚
3. **æ¶æ„é‡æ„**ï¼šåˆ›å»ºé€šç”¨èŠ‚ç‚¹ç»„ä»¶ `NodeContainer` å’Œ `NodeHeader`ï¼Œæé«˜ä»£ç å¤ç”¨æ€§ã€‚
4. **èŠ‚ç‚¹ç»„ä»¶é‡æ„**ï¼šé€ä¸€é‡æ„ `TextNode`ã€`CodeNode`ã€`ImageNode`ã€`MarkdownNode`ã€`TodoNode` ç»„ä»¶ã€‚
5. **åŠŸèƒ½å¢å¼º**ï¼šä¸ºå›¾ç‰‡èŠ‚ç‚¹æ·»åŠ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å’Œæè¿°æ˜¾ç¤ºåŠŸèƒ½ã€‚
6. **ç¼–è¾‘åŠŸèƒ½ä¿®å¤**ï¼šå‘ç°å¹¶ä¿®å¤æ‰€æœ‰èŠ‚ç‚¹ç»„ä»¶ç¼ºå°‘ React hooks å¯¼å…¥çš„é—®é¢˜ã€‚
7. **ä»£ç ä¼˜åŒ–**ï¼šæ¸…ç†æœªä½¿ç”¨çš„å˜é‡å’Œå‡½æ•°ï¼Œç¡®ä¿ä»£ç è´¨é‡ã€‚

## ğŸ’» å…³é”®ä»£ç å®ç°

**æ–‡ä»¶è·¯å¾„ï¼š[NodeHeader.tsx](https://github.com/JacksonHe04/flow-flat/tree/main/src/components/Node/NodeHeader.tsx)**

```typescript
import React, { useState, useCallback } from 'react';

interface NodeHeaderProps {
  nodeType: string;
  title: string;
  isEditing: boolean;
  onTitleChange: (title: string) => void;
  onEditStart: () => void;
  onEditEnd: () => void;
  onKeyDown?: (e: React.KeyboardEvent) => void;
}

const getNodeTypeDisplayName = (nodeType: string): string => {
  const typeMap: Record<string, string> = {
    text: 'æ–‡æœ¬',
    code: 'ä»£ç ',
    image: 'å›¾ç‰‡',
    markdown: 'Markdown',
    todo: 'å¾…åŠäº‹é¡¹'
  };
  return typeMap[nodeType] || nodeType;
};

/**
 * é€šç”¨èŠ‚ç‚¹å¤´éƒ¨ç»„ä»¶
 * æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹å’Œå¯ç¼–è¾‘çš„æ ‡é¢˜
 */
const NodeHeader: React.FC<NodeHeaderProps> = ({
  nodeType,
  title,
  isEditing,
  onTitleChange,
  onEditStart,
  onEditEnd,
  onKeyDown
}) => {
  const [localTitle, setLocalTitle] = useState(title);

  const handleDoubleClick = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    onEditStart();
  }, [onEditStart]);

  const handleBlur = useCallback(() => {
    onEditEnd();
    onTitleChange(localTitle);
  }, [localTitle, onTitleChange, onEditEnd]);

  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      (e.currentTarget as HTMLElement).blur();
    }
    e.stopPropagation();
    onKeyDown?.(e);
  }, [onKeyDown]);

  // åŒæ­¥å¤–éƒ¨titleå˜åŒ–
  React.useEffect(() => {
    setLocalTitle(title);
  }, [title]);

  return (
    <div className="mb-2">
      {/* èŠ‚ç‚¹ç±»å‹æ˜¾ç¤º */}
      <div className="text-xs text-gray-400 text-center mb-1">
        {getNodeTypeDisplayName(nodeType)}
      </div>
      
      {/* èŠ‚ç‚¹æ ‡é¢˜ */}
      {isEditing ? (
        <input
          className="w-full bg-transparent border-none outline-none text-sm font-semibold text-gray-600 dark:text-gray-300 text-center"
          value={localTitle}
          onChange={(e) => setLocalTitle(e.target.value)}
          onBlur={handleBlur}
          onKeyDown={handleKeyDown}
          autoFocus
        />
      ) : (
        <h3 
          className="text-sm font-semibold text-gray-600 dark:text-gray-300 cursor-pointer hover:text-gray-800 dark:hover:text-gray-100 text-center"
          onDoubleClick={handleDoubleClick}
        >
          {title}
        </h3>
      )}
    </div>
  );
};

export default NodeHeader;
```

**æ–‡ä»¶è·¯å¾„ï¼š[NodeContainer.tsx](https://github.com/JacksonHe04/flow-flat/tree/main/src/components/Node/NodeContainer.tsx)**

```typescript
import React from 'react';
import { Handle, Position } from '@xyflow/react';

interface NodeContainerProps {
  children: React.ReactNode;
  selected?: boolean;
  onDelete?: () => void;
}

/**
 * é€šç”¨èŠ‚ç‚¹å®¹å™¨ç»„ä»¶
 * åŒ…å«è¿æ¥ç‚¹ã€åˆ é™¤æŒ‰é’®å’ŒåŸºç¡€æ ·å¼
 */
const NodeContainer: React.FC<NodeContainerProps> = ({ 
  children, 
  selected, 
  onDelete 
}) => {
  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    onDelete?.();
  };

  return (
    <div className={`card card-hover ${selected ? 'border-primary' : ''} relative group`}>
      {/* è¿æ¥ç‚¹ */}
      <Handle 
        type="target" 
        position={Position.Left} 
        id="input" 
        className="w-3 h-3 bg-blue-500 border-2 border-white" 
      />
      <Handle 
        type="source" 
        position={Position.Right} 
        id="output" 
        className="w-3 h-3 bg-green-500 border-2 border-white" 
      />
      
      {/* åˆ é™¤æŒ‰é’® */}
      {onDelete && (
        <button
          className="
            absolute -top-2 -right-2 w-6 h-6
            bg-error text-white rounded-full
            opacity-0 group-hover:opacity-100
            hover:bg-red-600 transition-all duration-200
            flex items-center justify-center
          "
          onClick={handleDelete}
        >
          Ã—
        </button>
      )}

      {/* èŠ‚ç‚¹å†…å®¹ */}
      <div className="w-full h-full p-2">
        {children}
      </div>
    </div>
  );
};

export default NodeContainer;
```

**æ–‡ä»¶è·¯å¾„ï¼š[ImageNode.tsx](https://github.com/JacksonHe04/flow-flat/tree/main/src/components/Node/ImageNode.tsx)**

```typescript
import React, { useState, useCallback, useRef } from 'react';
import { type NodeProps, type Node } from '@xyflow/react';
import { useNodeStore } from '@/stores/nodeStore';
import NodeContainer from './NodeContainer';
import NodeHeader from './NodeHeader';

interface ImageNodeData extends Record<string, unknown> {
  title?: string;
  imageUrl?: string;
  alt?: string;
  description?: string;
  onDelete?: () => void;
}

/**
 * å›¾ç‰‡èŠ‚ç‚¹ç»„ä»¶
 */
const ImageNode: React.FC<NodeProps<Node<ImageNodeData>>> = ({ id, data, selected }) => {
  const { updateNodeData } = useNodeStore();
  const [isEditing, setIsEditing] = useState(false);
  const [imageUrl, setImageUrl] = useState(data?.imageUrl || '');
  const [title, setTitle] = useState(data?.title || 'å›¾ç‰‡èŠ‚ç‚¹');
  const [alt, setAlt] = useState(data?.alt || 'å›¾ç‰‡æè¿°');
  const [description, setDescription] = useState(data?.description || '');
  const fileInputRef = useRef<HTMLInputElement>(null);

  /**
   * å¤„ç†æ–‡ä»¶ä¸Šä¼ 
   */
  const handleFileUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const result = event.target?.result as string;
        setImageUrl(result);
        updateNodeData(id, { imageUrl: result, title, alt, description });
      };
      reader.readAsDataURL(file);
    }
  }, [id, title, alt, description, updateNodeData]);

  /**
   * å¤„ç†ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
   */
  const handleUploadClick = useCallback(() => {
    fileInputRef.current?.click();
  }, []);

  // ... å…¶ä»–å¤„ç†å‡½æ•°

  return (
    <NodeContainer 
      selected={selected} 
      onDelete={data?.onDelete}
    >
      <NodeHeader
        nodeType="image"
        title={title}
        isEditing={isEditing}
        onTitleChange={handleTitleChange}
        onEditStart={handleEditStart}
        onEditEnd={handleEditEnd}
        onKeyDown={handleKeyDown}
      />
      
      {/* å›¾ç‰‡å†…å®¹åŒºåŸŸ */}
      {isEditing ? (
        <div className="space-y-2">
          <input
            className="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 text-xs py-1 focus:outline-none focus:border-blue-500 dark:text-white"
            placeholder="å›¾ç‰‡URLæˆ–ç‚¹å‡»ä¸Šä¼ "
            value={imageUrl}
            onChange={e => setImageUrl(e.target.value)}
            onBlur={handleBlur}
          />
          <textarea
            className="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 text-xs py-1 focus:outline-none focus:border-blue-500 dark:text-white resize-none"
            placeholder="å›¾ç‰‡æè¿°"
            value={description}
            onChange={e => setDescription(e.target.value)}
            onBlur={handleBlur}
            rows={2}
          />
          <button
            className="w-full bg-blue-500 text-white text-xs py-1 rounded hover:bg-blue-600 transition-colors duration-200"
            onClick={handleUploadClick}
          >
            ä¸Šä¼ å›¾ç‰‡
          </button>
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            onChange={handleFileUpload}
            className="hidden"
          />
        </div>
      ) : (
        <div className="text-center">
          {imageUrl ? (
            <div>
              <img 
                src={imageUrl} 
                alt={alt}
                className="max-w-full h-auto rounded border"
                onError={() => setImageUrl('')}
              />
              {description && (
                <p className="text-xs text-gray-600 dark:text-gray-400 mt-2">
                  {description}
                </p>
              )}
            </div>
          ) : (
            <div 
              className="w-full h-24 bg-gray-100 dark:bg-gray-800 rounded border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"
              onDoubleClick={handleDoubleClick}
            >
              <span className="text-gray-500 dark:text-gray-400 text-xs">åŒå‡»æ·»åŠ å›¾ç‰‡</span>
            </div>
          )}
        </div>
      )}
    </NodeContainer>
  );
};

export default ImageNode;
```

## ğŸ› é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

- **é—®é¢˜**ï¼š`Toolbar.tsx` æ–‡ä»¶ä¸­ `NodeTypeConfig` ç±»å‹ä¸Šä¸å­˜åœ¨ `title` å±æ€§
- **è§£å†³æ–¹æ¡ˆ**ï¼šå°†æ‰€æœ‰å¯¹ `title` å±æ€§çš„å¼•ç”¨æ›¿æ¢ä¸º `name` å±æ€§

- **é—®é¢˜**ï¼šæ‰€æœ‰èŠ‚ç‚¹ç»„ä»¶éƒ½æ— æ³•ç¼–è¾‘ï¼ŒåŒå‡»æ— å“åº”
- **è§£å†³æ–¹æ¡ˆ**ï¼šä¸ºæ‰€æœ‰èŠ‚ç‚¹ç»„ä»¶æ·»åŠ ç¼ºå¤±çš„ `React, { useState, useCallback }` å¯¼å…¥

- **é—®é¢˜**ï¼šå›¾ç‰‡èŠ‚ç‚¹æ— æ³•è¾“å…¥ä¿¡æ¯ï¼Œç¼ºå°‘æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œä½¿ç”¨ `FileReader` API å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼Œæ·»åŠ æè¿°å­—æ®µ

- **é—®é¢˜**ï¼šå›¾ç‰‡æè¿°æœªæ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹æ–¹
- **è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸä¸‹æ–¹æ·»åŠ æè¿°æ–‡æœ¬æ˜¾ç¤º

- **é—®é¢˜**ï¼šä»£ç å¤ç”¨æ€§å·®ï¼Œå„èŠ‚ç‚¹ç»„ä»¶å­˜åœ¨é‡å¤ä»£ç 
- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»º `NodeContainer` å’Œ `NodeHeader` é€šç”¨ç»„ä»¶ï¼Œå°è£…å…¬å…±é€»è¾‘

- **é—®é¢˜**ï¼šTypeScript è¯Šæ–­é”™è¯¯ï¼Œå­˜åœ¨æœªä½¿ç”¨çš„å˜é‡
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ¸…ç† `handleDelete` ç­‰æœªä½¿ç”¨çš„å‡½æ•°å’Œå˜é‡

## âœ… æœ€ç»ˆç»“è®º

æœ¬æ¬¡å¼€å‘æˆåŠŸå®Œæˆäº† Flow-Flat èŠ‚ç‚¹ç»„ä»¶ç³»ç»Ÿçš„å…¨é¢é‡æ„å’ŒåŠŸèƒ½å¢å¼ºï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹ç±»å‹ï¼ˆæ–‡æœ¬ã€ä»£ç ã€å›¾ç‰‡ã€Markdownã€å¾…åŠäº‹é¡¹ï¼‰éƒ½æ”¯æŒå®Œæ•´çš„ç¼–è¾‘åŠŸèƒ½
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå®ç°äº†è‡ªå®šä¹‰æ ‡é¢˜ç¼–è¾‘ã€èŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºã€å›¾ç‰‡ä¸Šä¼ ç­‰ç”¨æˆ·å‹å¥½åŠŸèƒ½
3. **ä»£ç è´¨é‡**ï¼šé€šè¿‡åˆ›å»ºé€šç”¨ç»„ä»¶å¤§å¹…æé«˜äº†ä»£ç å¤ç”¨æ€§ï¼Œå‡å°‘äº†é‡å¤ä»£ç 
4. **ç±»å‹å®‰å…¨**ï¼šä¿®å¤äº†æ‰€æœ‰ TypeScript ç±»å‹é”™è¯¯å’Œè¯Šæ–­é—®é¢˜
5. **åŠŸèƒ½ç¨³å®š**ï¼šæ‰€æœ‰ç¼–è¾‘åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ”¯æŒåŒå‡»ç¼–è¾‘ã€è‡ªåŠ¨ä¿å­˜ç­‰äº¤äº’

é¡¹ç›®ç°åœ¨å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œç”¨æˆ·å¯ä»¥æµç•…åœ°åˆ›å»ºã€ç¼–è¾‘å’Œç®¡ç†å„ç§ç±»å‹çš„èŠ‚ç‚¹ï¼Œå¼€å‘æœåŠ¡å™¨è¿è¡Œç¨³å®šã€‚